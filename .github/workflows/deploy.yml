name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:

env:
  DOCKER_IMAGE: aviorma/tx-gateway

jobs:
  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ./infra

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ./infra

      - name: Terraform Validate
        run: terraform validate
        working-directory: ./infra

      - name: Validation Summary
        run: |
          echo "✅ Terraform validation successful"
          echo "✅ Code formatting is correct"
          echo "✅ Configuration is valid"

  build-test-push:
    runs-on: ubuntu-latest
    needs: terraform-validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t $DOCKER_IMAGE:${{ github.sha }} .

      - name: Test nginx configuration
        run: docker run --rm --entrypoint nginx $DOCKER_IMAGE:${{ github.sha }} -t

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USER }}" --password-stdin

      - name: Push Docker image (SHA tag)
        if: github.event_name != 'pull_request'
        run: docker push $DOCKER_IMAGE:${{ github.sha }}

      - name: Tag and push with version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          docker tag $DOCKER_IMAGE:${{ github.sha }} $DOCKER_IMAGE:${{ github.ref_name }}
          docker tag $DOCKER_IMAGE:${{ github.sha }} $DOCKER_IMAGE:latest
          docker push $DOCKER_IMAGE:${{ github.ref_name }}
          docker push $DOCKER_IMAGE:latest

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.12.0'

      # In real deployment, configure GKE credentials here:
      # - name: Authenticate to GKE
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: '${{ secrets.GCP_SA_KEY }}'
      # - name: Get GKE credentials
      #   uses: google-github-actions/get-gke-credentials@v2
      #   with:
      #     cluster_name: tx-gateway-staging
      #     location: us-central1

      - name: Validate Helm Chart
        run: |
          # Validate the Helm chart renders correctly
          helm template tx-gateway ./helm/tx-gateway \
            --namespace tx-gateway-staging \
            --values ./helm/values/values-staging.yaml \
            --set image.repository=${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ github.sha }} \
            --validate > /dev/null
          echo "✅ Helm chart validation successful"

      # Uncomment when deploying to real cluster:
      # - name: Deploy to Staging
      #   run: |
      #     helm upgrade --install tx-gateway ./helm/tx-gateway \
      #       --namespace tx-gateway-staging \
      #       --create-namespace \
      #       --values ./helm/values/values-staging.yaml \
      #       --set image.repository=${{ env.DOCKER_IMAGE }} \
      #       --set image.tag=${{ github.sha }} \
      #       --wait \
      #       --timeout 5m

      - name: Deployment Summary
        run: |
          echo "✅ Staging deployment validated"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}"
          echo "Namespace: tx-gateway-staging"
          echo "Note: Uncomment deployment step when cluster credentials are configured"

  deploy-prod:
    runs-on: ubuntu-latest
    needs: build-test-push
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://tx-gateway.example.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.12.0'

      # In real deployment, configure GKE credentials here:
      # - name: Authenticate to GKE
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: '${{ secrets.GCP_SA_KEY_PROD }}'
      # - name: Get GKE credentials
      #   uses: google-github-actions/get-gke-credentials@v2
      #   with:
      #     cluster_name: tx-gateway-production
      #     location: us-central1

      - name: Validate Helm Chart
        run: |
          # Validate the Helm chart renders correctly
          helm template tx-gateway ./helm/tx-gateway \
            --namespace tx-gateway-prod \
            --values ./helm/values/values-production.yaml \
            --set image.repository=${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ github.ref_name }} \
            --validate > /dev/null
          echo "✅ Helm chart validation successful"

      # Uncomment when deploying to real cluster:
      # - name: Deploy to Production
      #   run: |
      #     helm upgrade --install tx-gateway ./helm/tx-gateway \
      #       --namespace tx-gateway-prod \
      #       --create-namespace \
      #       --values ./helm/values/values-production.yaml \
      #       --set image.repository=${{ env.DOCKER_IMAGE }} \
      #       --set image.tag=${{ github.ref_name }} \
      #       --wait \
      #       --timeout 10m \
      #       --atomic

      - name: Deployment Summary
        run: |
          echo "✅ Production deployment validated"
          echo "Version: ${{ github.ref_name }}"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.ref_name }}"
          echo "Namespace: tx-gateway-prod"
          echo "Note: Uncomment deployment step when cluster credentials are configured"
