name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:

env:
  DOCKER_IMAGE: aviorma/tx-gateway

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t $DOCKER_IMAGE:${{ github.sha }} .

      - name: Test nginx configuration
        run: docker run --rm --entrypoint nginx $DOCKER_IMAGE:${{ github.sha }} -t

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USER }}" --password-stdin

      - name: Push Docker image (SHA tag)
        if: github.event_name != 'pull_request'
        run: docker push $DOCKER_IMAGE:${{ github.sha }}

      - name: Tag and push with version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          docker tag $DOCKER_IMAGE:${{ github.sha }} $DOCKER_IMAGE:${{ github.ref_name }}
          docker tag $DOCKER_IMAGE:${{ github.sha }} $DOCKER_IMAGE:latest
          docker push $DOCKER_IMAGE:${{ github.ref_name }}
          docker push $DOCKER_IMAGE:latest

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.12.0'

      # In real deployment, configure GKE credentials here:
      # - name: Authenticate to GKE
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: '${{ secrets.GCP_SA_KEY }}'
      # - name: Get GKE credentials
      #   uses: google-github-actions/get-gke-credentials@v2
      #   with:
      #     cluster_name: tx-gateway-staging
      #     location: us-central1

      - name: Deploy to Staging
        run: |
          # Dry-run for demonstration (remove --dry-run for real deployment)
          helm upgrade --install tx-gateway ./helm/tx-gateway \
            --namespace tx-gateway-staging \
            --create-namespace \
            --values ./helm/values/values-staging.yaml \
            --set image.repository=${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ github.sha }} \
            --wait \
            --timeout 5m \
            --dry-run

      - name: Deployment Summary
        run: |
          echo "✅ Staging deployment completed"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}"
          echo "Namespace: tx-gateway-staging"

  deploy-prod:
    runs-on: ubuntu-latest
    needs: build-test-push
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://tx-gateway.example.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.12.0'

      # In real deployment, configure GKE credentials here:
      # - name: Authenticate to GKE
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: '${{ secrets.GCP_SA_KEY_PROD }}'
      # - name: Get GKE credentials
      #   uses: google-github-actions/get-gke-credentials@v2
      #   with:
      #     cluster_name: tx-gateway-production
      #     location: us-central1

      - name: Deploy to Production
        run: |
          # Dry-run for demonstration (remove --dry-run for real deployment)
          helm upgrade --install tx-gateway ./helm/tx-gateway \
            --namespace tx-gateway-prod \
            --create-namespace \
            --values ./helm/values/values-production.yaml \
            --set image.repository=${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ github.ref_name }} \
            --wait \
            --timeout 10m \
            --atomic \
            --dry-run

      - name: Deployment Summary
        run: |
          echo "✅ Production deployment completed"
          echo "Version: ${{ github.ref_name }}"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.ref_name }}"
          echo "Namespace: tx-gateway-prod"
